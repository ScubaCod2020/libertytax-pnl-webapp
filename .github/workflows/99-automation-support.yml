name: '99 â†’ Support Automation'

on:
  # Triggered by main deployment workflows
  workflow_run:
    workflows:
      [
        '01 â†’ Code Quality & Analysis',
        '02 â†’ Build & Test',
        '03 â†’ Deploy to Staging',
        '04 â†’ Deploy to Production',
      ]
    types: [completed]

  # Manual triggers for specific automations
  workflow_dispatch:
    inputs:
      action:
        description: 'Automation action to run'
        required: true
        type: choice
        options:
          - update-wiki
          - create-issues
          - update-board
          - full-automation

  # Scheduled maintenance
  schedule:
    # Weekly automation maintenance
    - cron: '0 10 * * 1' # Monday 10 AM UTC

permissions:
  contents: read
  issues: write

jobs:
  # Issue creation from workflow failures
  handle-failures:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: ${{ github.event.workflow_run.conclusion == 'failure' || (github.event_name == 'workflow_dispatch' && inputs.action == 'create-issues') }}

    steps:
      - name: ðŸŽ¯ Create issue from workflow failure
        uses: actions/github-script@v7
        with:
          script: |
            const isManual = context.eventName === 'workflow_dispatch';
            const inputs = context.payload?.inputs || {};
            const wr = context.payload?.workflow_run || {};

            const workflowName = isManual ? (inputs.sim_workflow_name || 'Manual') : (wr.name || 'Unknown');
            const runUrl = isManual ? (inputs.sim_run_url || `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`) : (wr.html_url || '');
            const commitSha = isManual ? (inputs.sim_sha || context.sha) : (wr.head_sha || context.sha);

            const isProd = workflowName.includes('Production');
            const isStaging = workflowName.includes('Staging');
            const priority = isProd ? 'ðŸš¨ HIGH' : (isStaging ? 'âš ï¸ MEDIUM' : 'ðŸ“ LOW');
            const labels = ['bug', 'workflow-failure'];
            if (isProd) labels.push('critical');

            // Create issue for failed workflow
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Workflow Failure: ${workflowName}`,
              body: `
            ## Workflow Failure Report

            **Workflow**: ${workflowName}
            **Run URL**: ${runUrl}
            **Commit**: ${commitSha}
            **Failure Time**: ${new Date().toISOString()}

            ### Automated Analysis
            This issue was automatically created due to a workflow failure.

            ### Investigation Steps
            - [ ] Review workflow logs for specific error details
            - [ ] Check if this is a recurring issue
            - [ ] Identify root cause (code, infrastructure, or configuration)
            - [ ] Implement fix and test
            - [ ] Update workflow if needed

            ### Priority Assessment
            ${priority}
              `,
              labels
            });

            console.log('Created issue #' + issue.data.number + ' for workflow failure');

  # Project board automation
  update-project-board:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: >
      ${{ 
        github.event.workflow_run.conclusion == 'success' || 
        github.event_name == 'workflow_dispatch' ||
        github.event_name == 'schedule'
      }}

    steps:
      - name: ðŸ“Š Update project board status
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ðŸŽ¯ Updating project board based on workflow status...');
            const isManual = context.eventName === 'workflow_dispatch';
            const inputs = context.payload?.inputs || {};
            const wr = context.payload?.workflow_run || {};
            const workflowName = isManual ? (inputs.sim_workflow_name || 'Manual') : (wr.name || 'Manual');
            const workflowStatus = isManual ? (inputs.sim_conclusion || 'manual') : (wr.conclusion || 'manual');

            // Simulate project board updates
            if (workflowName.includes('Code Quality')) {
              console.log('âœ… Moving quality issues to "In Review"');
            } else if (workflowName.includes('Build & Test')) {
              console.log('âœ… Moving build issues to "Testing"');
            } else if (workflowName.includes('Deploy')) {
              console.log('âœ… Moving deployment issues to "Done"');
            }

            console.log(`Project board updated for ${workflowName} (${workflowStatus})`);

  # Wiki updates
  update-wiki:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    if: >
      ${{ 
        github.event.workflow_run.name == '04 â†’ Deploy to Production' &&
        github.event.workflow_run.conclusion == 'success' ||
        github.event_name == 'schedule' ||
        inputs.action == 'update-wiki' ||
        inputs.action == 'full-automation'
      }}

    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: ðŸ”„ Checkout wiki
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§± Prepare wiki structure
        run: |
          set -e
          mkdir -p wiki/Architecture wiki/Automation wiki/Workflows wiki/Snapshots wiki/Runbooks wiki/Testing wiki/Growth wiki/Docs
          # Home
          if [ -f MASTER_INDEX.md ]; then
            cp MASTER_INDEX.md wiki/Home.md
          elif [ -f docs/INDEX.md ]; then
            cp docs/INDEX.md wiki/Home.md
          else
            if [ ! -f wiki/Home.md ]; then
              echo "# Liberty Tax P&L Webapp Wiki" > wiki/Home.md
              echo >> wiki/Home.md
              echo "Welcome. See the sidebar for sections." >> wiki/Home.md
            fi
          fi
          # Sidebar
          cat > wiki/_Sidebar.md <<'EOF'
          - [Home](Home)
          - [Overview](Docs/_Index)
          - [Architecture](Architecture)
          - [Runbooks](Runbooks)
          - [Testing](Testing)
          - [Workflows](Workflows/Overview)
          - [Growth](Growth)
          - [Snapshots](Snapshots)
          EOF

      - name: ðŸ“š Sync repository docs to wiki
        run: |
          set -e
          echo "::group::Mirror docs to wiki"
          # Architecture docs
          if [ -d docs/architecture ]; then
            rsync -a --delete docs/architecture/ wiki/Architecture/ || true
          fi
          # UI snapshots (artifacted or committed)
          if [ -d docs/ui-snapshots ]; then
            rsync -a docs/ui-snapshots/ wiki/Snapshots/ || true
          fi
          # Runbooks, Testing, Growth
          if [ -d docs/runbooks ]; then
            rsync -a docs/runbooks/ wiki/Runbooks/ || true
          fi
          if [ -d docs/testing ]; then
            rsync -a docs/testing/ wiki/Testing/ || true
          fi
          if [ -d docs/growth ]; then
            rsync -a docs/growth/ wiki/Growth/ || true
          fi
          # Catch-all docs to Docs/ (exclude mapped folders to avoid duplication)
          if [ -d docs ]; then
            rsync -a \
              --exclude 'architecture/' \
              --exclude 'ui-snapshots/' \
              --exclude 'runbooks/' \
              --exclude 'testing/' \
              --exclude 'growth/' \
              docs/ wiki/Docs/ || true
          fi
          echo "::endgroup::"
          # Workflows overview
          echo "# CI/CD Workflows" > wiki/Workflows/Overview.md
          echo >> wiki/Workflows/Overview.md
          echo "The following workflows are defined in \`.github/workflows\`:" >> wiki/Workflows/Overview.md
          echo >> wiki/Workflows/Overview.md
          echo "| Workflow | File |" >> wiki/Workflows/Overview.md
          echo "|---|---|" >> wiki/Workflows/Overview.md
          for f in .github/workflows/*.yml; do
            name=$(grep -m1 '^name:' "$f" | sed 's/name: //') || true
            base=$(basename "$f")
            echo "| ${name:-(unnamed)} | $base |" >> wiki/Workflows/Overview.md
          done

          # Progress summary (last 4 weeks)
          echo "# Progress â€” Last 4 Weeks" > wiki/Growth/Progress-Last-4-Weeks.md
          echo >> wiki/Growth/Progress-Last-4-Weeks.md
          git log --since="4 weeks ago" --pretty=format:"- %ad %h â€” %s" --date=short | head -n 200 >> wiki/Growth/Progress-Last-4-Weeks.md
          # Docs index
          echo "# Documentation Index" > wiki/Docs/_Index.md
          echo >> wiki/Docs/_Index.md
          find wiki/Docs -type f -name '*.md' -printf "- %P\n" | sort >> wiki/Docs/_Index.md

      - name: ðŸ” Configure git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

      - name: ðŸš€ Commit and push wiki changes
        run: |
          cd wiki
          if git status --porcelain | grep .; then
            git add .
            git commit -m "docs(wiki): sync repository docs to wiki"
            git push
          else
            echo "No wiki changes to commit"
          fi

      - name: ðŸ”Ž Debug wiki remote
        run: |
          cd wiki
          git remote -v
          git branch -vv || true

      - name: ðŸ“Š Wiki update summary
        run: |
          echo "## ðŸ“š Wiki Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "Updated sections:" >> $GITHUB_STEP_SUMMARY
          echo "- Architecture" >> $GITHUB_STEP_SUMMARY
          echo "- Workflows" >> $GITHUB_STEP_SUMMARY
          echo "- Snapshots (if present)" >> $GITHUB_STEP_SUMMARY
          echo "- Runbooks" >> $GITHUB_STEP_SUMMARY
          echo "- Testing" >> $GITHUB_STEP_SUMMARY
          echo "- Growth (includes 'Progress â€” Last 4 Weeks')" >> $GITHUB_STEP_SUMMARY

  # Comprehensive automation summary
  automation-summary:
    runs-on: ubuntu-latest
    needs: [handle-failures, update-project-board, update-wiki]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ðŸ“Š Automation report
        run: |
          echo "## ðŸ¤– Support Automation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Action Taken |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|--------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Issue Management | ${{ needs.handle-failures.result == 'success' && 'âœ… Active' || needs.handle-failures.result == 'skipped' && 'âž– Skipped' || 'âŒ Failed' }} | ${{ github.event.workflow_run.conclusion == 'failure' && 'Created failure issue' || 'No issues needed' }} |" >> $GITHUB_STEP_SUMMARY  
          echo "| Project Board | ${{ needs.update-project-board.result == 'success' && 'âœ… Updated' || 'âž– Skipped' }} | Board status synchronized |" >> $GITHUB_STEP_SUMMARY
          echo "| Wiki Updates | ${{ needs.update-wiki.result == 'success' && 'âœ… Updated' || 'âž– Skipped' }} | Documentation synchronized |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Next Automation Run" >> $GITHUB_STEP_SUMMARY
          echo "**Scheduled**: Weekly maintenance (Mondays 10 AM UTC)" >> $GITHUB_STEP_SUMMARY
          echo "**Manual**: Use 'Support Automation' workflow dispatch" >> $GITHUB_STEP_SUMMARY
