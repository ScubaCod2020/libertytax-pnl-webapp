name: ðŸ”„ Continuous Integration

on:
  push:
    branches: [ main, develop, 'feat/**', 'fix/**' ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================
  # ðŸ§ª Testing Jobs (Parallel Execution)
  # ==========================================
  
  lint:
    name: ðŸ” Code Quality & Linting
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ” TypeScript compilation check
        run: npx tsc --noEmit
        
      - name: ðŸŽ¨ ESLint check
        run: npx eslint src --ext .ts,.tsx --max-warnings 0
        continue-on-error: true
        
      - name: ðŸ’„ Prettier check
        run: npx prettier --check "src/**/*.{ts,tsx,css}"
        continue-on-error: true

  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['18.x', '20.x']
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ§ª Run unit tests
        run: npm run test:unit
        continue-on-error: true
        
      - name: ðŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v3
        if: matrix.node-version == '20.x'
        with:
          directory: ./coverage/

  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ—ï¸ Build application
        run: npm run build
        
      - name: ðŸ”— Run integration tests
        run: npm run test:integration

  browser-tests:
    name: ðŸŒ End-to-End Browser Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸŽ­ Install Playwright
        run: npx playwright install --with-deps
        
      - name: ðŸ—ï¸ Build application
        run: npm run build
        
      - name: ðŸš€ Start preview server
        run: npm run preview &
        
      - name: â³ Wait for server
        run: npx wait-on http://localhost:4173 --timeout 30000
        
      - name: ðŸŒ Run Playwright tests
        run: npx playwright test
        
      - name: ðŸ“¤ Upload Playwright report
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  mobile-tests:
    name: ðŸ“± Mobile & Responsive Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸŽ­ Install Playwright
        run: npx playwright install --with-deps
        
      - name: ðŸ—ï¸ Build application
        run: npm run build
        
      - name: ðŸš€ Start preview server
        run: npm run preview &
        
      - name: â³ Wait for server
        run: npx wait-on http://localhost:4173 --timeout 30000
        
      - name: ðŸ“± Run mobile viewport tests
        run: npx playwright test --config=playwright.mobile.config.js

  performance-tests:
    name: âš¡ Performance & Lighthouse Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ—ï¸ Build application
        run: npm run build
        
      - name: ðŸ’¡ Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x
        
      - name: ðŸš€ Start preview server
        run: npm run preview &
        
      - name: â³ Wait for server
        run: npx wait-on http://localhost:4173 --timeout 30000
        
      - name: âš¡ Run Lighthouse CI
        run: lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  security-audit:
    name: ðŸ”’ Security & Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ”’ Run security audit
        run: npm audit --audit-level=moderate
        
      - name: ðŸ›¡ï¸ Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --token=${{ secrets.SNYK_TOKEN }}

  python-tests:
    name: ðŸ Python Excel Tool Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: ðŸ”§ Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
          
      - name: ðŸ§ª Run Python tests
        run: |
          # Create a simple test to verify Python environment
          python -c "import sys; print(f'Python {sys.version}')"
          # Test if the main Python script can be imported
          python -c "import src.build_pnl_tool_v5; print('Python script imports successfully')"
        
      - name: ðŸ—ï¸ Test Excel tool build
        run: python src/build_pnl_tool_v5.py

  # ==========================================
  # ðŸ“Š Test Results Summary
  # ==========================================
  test-summary:
    name: ðŸ“Š Test Results Summary
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, browser-tests, mobile-tests, performance-tests, security-audit, python-tests]
    if: always()
    steps:
      - name: ðŸ“Š Test Results Summary
        run: |
          echo "## ðŸŽ¯ Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Linting | ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Integration | ${{ needs.integration-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Browser Tests | ${{ needs.browser-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“± Mobile Tests | ${{ needs.mobile-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ Performance | ${{ needs.performance-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security | ${{ needs.security-audit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ Python Tools | ${{ needs.python-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY