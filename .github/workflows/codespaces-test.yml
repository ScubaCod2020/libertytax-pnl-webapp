name: ğŸ§ª Codespaces Testing

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - unit
        - integration
        - e2e
        - mobile
        - performance
        - security

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ­ Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: ğŸ—ï¸ Build application
      run: npm run build
      
    - name: ğŸ§ª Run Unit Tests
      if: ${{ github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'unit' }}
      run: npm run test:unit
      
    - name: ğŸ”— Run Integration Tests
      if: ${{ github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'integration' }}
      run: npm run test:integration
      
    - name: ğŸŒ Run E2E Tests
      if: ${{ github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'e2e' }}
      run: npm run test:e2e
      
    - name: ğŸ“± Run Mobile Tests
      if: ${{ github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'mobile' }}
      run: npm run test:mobile
      
    - name: âš¡ Run Performance Tests
      if: ${{ github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'performance' }}
      run: npm run test:performance
      
    - name: ğŸ”’ Run Security Scan
      if: ${{ github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'security' }}
      run: npm audit --audit-level=moderate
      
    - name: ğŸ“Š Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          playwright-results.json
          playwright-results.xml
          test-results/
        retention-days: 7
        
    - name: ğŸ“ˆ Log Test Results
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `## ğŸ§ª Test Results
          
          **Status**: ${context.job.status === 'success' ? 'âœ… Passed' : 'âŒ Failed'}
          **Triggered by**: Manual workflow dispatch
          **Test Type**: ${context.payload.inputs.test_type || 'all'}
          
          ### Test Summary
          - **Unit Tests**: ${context.job.status === 'success' ? 'âœ…' : 'âŒ'}
          - **Integration Tests**: ${context.job.status === 'success' ? 'âœ…' : 'âŒ'}
          - **E2E Tests**: ${context.job.status === 'success' ? 'âœ…' : 'âŒ'}
          - **Mobile Tests**: ${context.job.status === 'success' ? 'âœ…' : 'âŒ'}
          - **Performance Tests**: ${context.job.status === 'success' ? 'âœ…' : 'âŒ'}
          - **Security Scan**: ${context.job.status === 'success' ? 'âœ…' : 'âŒ'}
          
          [View detailed results](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
          `;
          
          console.log('Test results:', comment);
