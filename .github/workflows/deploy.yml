name: deploy

on:
  
  push:
    branches:
      - main
      - staging
      - 'feature/*'
      - 'fix/*'
      - 'chore/*'
  pull_request:
    branches:
      - main
      - staging
  workflow_dispatch:
    inputs:
      target_env:
        description: Where to deploy?
        type: choice
        required: true
        options: [Dev, Staging, Production]
        default: Dev

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  map-env:
    name: Select environment
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.detect.outputs.env_name }}
    steps:
      - id: detect
        name: Compute environment
        shell: bash
        run: |
          set -euo pipefail
          REF_NAME="${GITHUB_REF_NAME:-}"
          EVENT="${GITHUB_EVENT_NAME:-}"

          # If manually dispatched, honor the dropdown input
          if [[ "$EVENT" == "workflow_dispatch" ]]; then
            case "${{ inputs.target_env }}" in
              Dev|dev|Preview|preview)   ENV_NAME="Preview" ;;
              Staging|staging)           ENV_NAME="Staging" ;;
              Production|production|Prod|prod) ENV_NAME="Production" ;;
              *)                         ENV_NAME="Preview" ;;
            esac

          # PRs go to Preview (your DEV on Unraid)
          elif [[ "$EVENT" == "pull_request" ]]; then
            ENV_NAME="Preview"

          # Branch mapping
          elif [[ "$REF_NAME" == "staging" ]]; then
            ENV_NAME="Staging"
          elif [[ "$REF_NAME" == "main" || "$REF_NAME" == "master" ]]; then
            ENV_NAME="Production"
          else
            ENV_NAME="Preview"
          fi

          echo "env_name=$ENV_NAME" >> "$GITHUB_OUTPUT"
          echo "Selected environment: $ENV_NAME"



  build:
    name: Build & Deploy
    needs: map-env
    runs-on: [self-hosted, unraid]
    environment:
      name: ${{ needs.map-env.outputs.env_name }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: angular/package-lock.json   # <— NEW

      - name: Install (Angular)
        working-directory: angular                           # <— NEW
        run: npm ci

      - name: Build (Angular)
        working-directory: angular                           # <— NEW
        run: npx ng build --configuration "${{ vars.BUILD_CONFIGURATION || 'production' }}"

      - name: Resolve build output directory
        id: outdir
        run: |
          PATTERN="${{ vars.DIST_DIR || 'angular/dist/*/browser' }}"   # <— UPDATED DEFAULT
          CANDIDATE="$(ls -d ${PATTERN} 2>/dev/null | head -n1 || true)"
          if [ -z "$CANDIDATE" ]; then
            echo "❌ Could not find build output. Set repo variable DIST_DIR to your dist path." >&2
            echo "Dist tree (3 levels):"
            find angular/dist -maxdepth 3 -type d -print 2>/dev/null || true
            exit 1
          fi
          echo "outdir=$CANDIDATE" >> "$GITHUB_OUTPUT"
          echo "Using OUTDIR=$CANDIDATE"


      - name: Trigger Vercel deploy (optional; gated off by var)
        if: ${{ vars.SKIP_VERCEL != 'true' }}
        env:
          HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}
          BRANCH: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          if [ -n "$HOOK" ]; then
            echo "POST $HOOK"
            curl -fsSL -X POST -H "Content-Type: application/json" \
              -d "{\"branch\":\"$BRANCH\",\"repo\":\"$REPO\"}" \
              "$HOOK"
          else
            echo "No Vercel hook configured. Skipping."
          fi

      - name: Compute Unraid deploy path
        id: target
        env:
          ENV_NGINX_DEPLOY_PATH: ${{ vars.NGINX_DEPLOY_PATH }}
          ENV_NGINX_ROOT: ${{ vars.NGINX_ROOT }}
          ENV_APP_ENV: ${{ vars.APP_ENV }}
          ENV_APP_NAME: ${{ vars.APP_NAME || 'libertytax-pnl-webapp' }}
        run: |
          if [ -n "$ENV_NGINX_DEPLOY_PATH" ]; then
            echo "path=$ENV_NGINX_DEPLOY_PATH" >> "$GITHUB_OUTPUT"
          else
            echo "path=$ENV_NGINX_ROOT/$ENV_APP_ENV/$ENV_APP_NAME" >> "$GITHUB_OUTPUT"
          fi
          echo "Computed deploy path: $(grep '^path=' "$GITHUB_OUTPUT" | cut -d= -f2)"

      - name: Copy build to Unraid Nginx
        run: |
          DEST="${{ steps.target.outputs.path }}"
          SRC="${{ steps.outdir.outputs.outdir }}"
          echo "Deploy path: $DEST"
          mkdir -p "$DEST"
          rsync -av --delete "${SRC}/" "${DEST}/"
