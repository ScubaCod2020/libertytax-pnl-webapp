name: '02 â†’ Build & Test'

on:
  workflow_run:
    workflows: ['01 â†’ Code Quality & Analysis']
    types: [completed]
    branches: [main, develop, 'feat/*', 'fix/*']
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'

jobs:
  # Only run if code quality passed
  check-prerequisites:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}

    steps:
      - name: ðŸ” Check workflow prerequisites
        id: check
        run: |
          echo "should_build=true" >> $GITHUB_OUTPUT
          echo "âœ… Code quality passed - proceeding with build"

  build-and-test:
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: needs.check-prerequisites.outputs.should_build == 'true'

    outputs:
      build_success: ${{ steps.build.outputs.success }}
      bundle_size: ${{ steps.build.outputs.bundle_size }}
      test_results: ${{ steps.test.outputs.results }}

    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies (SHARED - build once)
        run: npm ci

      - name: ðŸ§® Run core calculation tests
        id: test
        run: |
          echo "ðŸ§® Testing calculation engine..."
          node scripts/test-calculations.js

          echo "ðŸ” Testing edge cases..."  
          node scripts/comprehensive-edge-case-tests.js

          echo "ðŸ”„ Testing regression scenarios..."
          node scripts/regression-test.js

          echo "results=passed" >> $GITHUB_OUTPUT
          echo "âœ… All calculation tests passed"

      - name: ðŸ—ï¸ Build application (SHARED - build once)
        id: build
        run: |
          echo "ðŸ—ï¸ Building application..."
          npm run build

          # Validate build artifacts
          [ -f "dist/index.html" ] || (echo "âŒ Missing index.html" && exit 1)
          [ -f dist/assets/index-*.js ] || (echo "âŒ Missing JavaScript bundle" && exit 1)
          [ -f dist/assets/index-*.css ] || (echo "âŒ Missing CSS bundle" && exit 1)

          # Calculate bundle sizes
          MAIN_BUNDLE=$(find dist/assets -name "index-*.js" -exec stat -c%s {} \; | sort -n | tail -1)
          VENDOR_BUNDLE=$(find dist/assets -name "vendor-*.js" -exec stat -c%s {} \; | sort -n | tail -1 || echo "0")
          TOTAL_SIZE=$((MAIN_BUNDLE + VENDOR_BUNDLE))

          echo "bundle_size=$((TOTAL_SIZE / 1024))" >> $GITHUB_OUTPUT
          echo "success=true" >> $GITHUB_OUTPUT

          echo "## ðŸ“Š Build Results" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Main Bundle | $((MAIN_BUNDLE / 1024))KB | $([ $MAIN_BUNDLE -lt 200000 ] && echo 'âœ… Good' || echo 'âš ï¸ Large') |" >> $GITHUB_STEP_SUMMARY
          echo "| Vendor Bundle | $((VENDOR_BUNDLE / 1024))KB | âœ… Optimized |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Size** | **$((TOTAL_SIZE / 1024))KB** | **$([ $TOTAL_SIZE -lt 350000 ] && echo 'âœ… Acceptable' || echo 'âŒ Too Large')** |" >> $GITHUB_STEP_SUMMARY

          if [ $TOTAL_SIZE -gt 350000 ]; then
            echo "âŒ Bundle size exceeds 350KB limit"
            exit 1
          fi

          echo "âœ… Build completed successfully"

      - name: ðŸ§ª Preview server test (SHARED - test once)
        run: |
          echo "ðŸ§ª Testing preview server..."

          # Start server in background
          npm run preview &
          SERVER_PID=$!

          # Wait for startup with timeout
          for i in {1..20}; do
            if curl -s http://localhost:4173 > /dev/null; then
              echo "âœ… Server started after ${i} seconds"
              break
            fi
            if [ $i -eq 20 ]; then
              echo "âŒ Server startup timeout"
              kill $SERVER_PID
              exit 1
            fi
            sleep 1
          done

          # Test critical functionality
          RESPONSE=$(curl -s http://localhost:4173)

          if echo "$RESPONSE" | grep -q "Liberty Tax"; then
            echo "âœ… Liberty Tax branding found"
          else
            echo "âŒ Liberty Tax branding missing"
            kill $SERVER_PID
            exit 1
          fi

          if echo "$RESPONSE" | grep -q "script"; then
            echo "âœ… JavaScript bundle loaded"
          else
            echo "âŒ JavaScript bundle missing"
            kill $SERVER_PID
            exit 1
          fi

          # Cleanup
          kill $SERVER_PID
          echo "âœ… Preview server tests passed"

      - name: ðŸ“¦ Upload build artifacts (SHARED)
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: |
            dist/
            package.json
            package-lock.json
          retention-days: 7

      - name: ðŸ“Š Test summary
        run: |
          echo "## âœ… Build & Test Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **Ready for deployment!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Created:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Optimized production build (${{ steps.build.outputs.bundle_size }}KB)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tested preview server" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Validated calculation engine" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Step**: Trigger staging deployment for validation" >> $GITHUB_STEP_SUMMARY
