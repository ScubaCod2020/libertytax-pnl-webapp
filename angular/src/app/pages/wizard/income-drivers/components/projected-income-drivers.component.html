<div class="proj-section">
  <div class="section-title">
    <div class="title-left"><span>üìà</span>Projected Performance</div>
    <button class="btn btn--secondary btn--sm" (click)="resetProjectedGoals()" title="Reset Projected Performance">
      Reset Projected
    </button>
  </div>

  <!-- Scenario Presets Row -->
  <div class="scenario-presets">
    <div class="preset-option">
      <input type="radio" id="good" name="scenario" value="2" [checked]="projSvc.growthPct === 2 && !isCustomSelected"
        (change)="selectPreset(2)" />
      <label for="good" class="preset-label good">
        <span class="preset-name">Good</span>
        <span class="preset-value">+2%</span>
      </label>
    </div>
    <div class="preset-option">
      <input type="radio" id="better" name="scenario" value="5" [checked]="projSvc.growthPct === 5 && !isCustomSelected"
        (change)="selectPreset(5)" />
      <label for="better" class="preset-label better">
        <span class="preset-name">Better</span>
        <span class="preset-value">+5%</span>
      </label>
    </div>
    <div class="preset-option">
      <input type="radio" id="best" name="scenario" value="10" [checked]="projSvc.growthPct === 10 && !isCustomSelected"
        (change)="selectPreset(10)" />
      <label for="best" class="preset-label best">
        <span class="preset-name">Best</span>
        <span class="preset-value">+10%</span>
      </label>
    </div>
    <div class="preset-option">
      <input type="radio" id="custom" name="scenario" value="custom" [checked]="isCustomSelected"
        (change)="selectCustomMode()" />
      <label for="custom" class="preset-label custom">
        <span class="preset-name">Custom</span>
        <span class="preset-value">Setup</span>
      </label>
    </div>
  </div>

  <!-- Custom Performance Change Controls (shown when Custom is selected) -->
  @if (isCustomSelected) {
  <div class="custom-performance-controls">
    <div class="row">
      <label>Performance Change</label>
      <div class="field">
        <div class="perf-input-group">
          <!-- Scenario Dropdown (React app style with named scenarios) -->
          <label for="scenario-select" class="sr-only">Performance Change Scenario</label>
          <select id="scenario-select" class="select" [ngModel]="getScenarioForDropdown()"
            (ngModelChange)="onDropdownScenarioChange($event)" title="Select performance change scenario">
            <option value="decline-10">Decline: -10%</option>
            <option value="decline-5">Decline: -5%</option>
            <option value="no-change">No Change: 0%</option>
            <option value="growth-5">Growth: +5%</option>
            <option value="growth-10">Growth: +10%</option>
            <option value="growth-15">Growth: +15%</option>
            <option value="growth-20">Growth: +20%</option>
            <option value="custom">Custom</option>
          </select>
          <label for="growth-percentage" class="sr-only">Growth Percentage</label>
          <input id="growth-percentage" type="number" class="input small" step="0.1" min="-50" max="100"
            [ngModel]="projSvc.growthPct" (ngModelChange)="projSvc.setGrowthPct($event)"
            title="Enter growth percentage (-50% to 100%)" />
          <span class="suffix">%</span>
        </div>
        <label for="growth-range" class="sr-only">Growth Percentage Range Slider</label>
        <input id="growth-range" type="range" class="range" min="-50" max="100" step="0.1" [ngModel]="projSvc.growthPct"
          (ngModelChange)="projSvc.setGrowthPct($event)" title="Adjust growth percentage using slider" />
      </div>
      <div class="note">Select a preset or enter a custom percentage</div>
    </div>
  </div>
  }

  <!-- Target Selection (Always Visible) -->
  <div class="row">
    <label>Apply Performance Change To</label>
    <div class="field">
      <div class="targets">
        <label class="target"><input type="checkbox" [checked]="projSvc.targets.all"
            (change)="projSvc.toggleTarget('all', $event.target.checked)" /> Apply to All</label>
        <label class="target"><input type="checkbox" [checked]="projSvc.targets.returns"
            (change)="projSvc.toggleTarget('returns', $event.target.checked)" /> Returns</label>
        <label class="target"><input type="checkbox" [checked]="projSvc.targets.avgNetFee"
            (change)="projSvc.toggleTarget('avgNetFee', $event.target.checked)" /> Avg Net Fee</label>
        <label class="target" *ngIf="showOtherIncome$ | async"><input type="checkbox"
            [checked]="projSvc.targets.otherIncome"
            (change)="projSvc.toggleTarget('otherIncome', $event.target.checked)" /> Other Income</label>
      </div>
    </div>
    <div class="note">Select which fields should be affected by the performance change percentage</div>
  </div>

  <!-- Returns & ANF (Projected from PY + Growth) -->
  <div class="row">
    <label>Tax Prep Returns</label>
    <div class="field">
      <div class="currency">
        <span class="prefix">#</span>
        <input type="number" class="input readonly" [ngModel]="projectedTaxPrepReturns$ | async"
          placeholder="Auto: PY + Growth %" readonly />
      </div>
    </div>
    <div class="note">Projected from Prior Year + {{ projSvc.growthPct }}% growth</div>
  </div>

  <div class="row">
    <label>Average Net Fee</label>
    <div class="field">
      <div class="currency anf">
        <span class="prefix">$</span>
        <input type="number" class="input" [ngClass]="anfStatus$ | async" [ngModel]="anfValue$ | async"
          (ngModelChange)="updateAnf($event)" />
        <span class="chip" [ngClass]="anfStatus$ | async"></span>
        <button type="button" class="icon" [title]="anfTooltip$ | async">‚ÑπÔ∏è</button>
        <button type="button" class="mini" (click)="updateAnf(recommendedAnfSnapshot() ?? 0)">Use recommended</button>
      </div>
    </div>
    <div class="note small" [ngClass]="anfStatus$ | async">{{ anfNote$ | async }}</div>
  </div>

  <!-- Gross (derived unless override) -->
  <div class="row">
    <label>Gross Tax Prep Fees</label>
    <div class="field">
      <div class="currency">
        <span class="prefix">$</span>
        <input type="number" class="input readonly" appCurrencyInput [ngModel]="projectedGrossFees$ | async"
          placeholder="Auto-calculated" readonly />
      </div>
    </div>
    <div class="note">Auto: Projected Returns √ó Projected Avg Net Fee</div>
  </div>

  <!-- TaxRush (projected) - conditional for CA AND TaxRush enabled -->
  @if (showTaxRush$ | async) {
  <div class="box info">
    <div class="box-title">TaxRush (Projected)</div>
    <div class="box-desc">Your projected TaxRush returns and avg fee</div>
    <div class="row compact">
      <label>TaxRush Returns</label>
      <div class="field">
        <div class="inline-gap">
          <input type="number" class="input xs" [ngModel]="taxRushReturns$ | async"
            (ngModelChange)="updateTaxRushReturns($event)" placeholder="180" />
          <span class="eq">=</span>
          <div class="inline">
            <input type="number" class="input xs" step="0.1" min="0" max="50" [ngModel]="taxRushReturnsPct$ | async"
              (ngModelChange)="updateTaxRushReturnsPct($event)" placeholder="15.0" />
            <span class="suffix">%</span>
          </div>
        </div>
        <div class="help italic">Auto: {{ (projectedTaxPrepReturns$ | async) || 0 }} √ó {{ (taxRushReturnsPct$ | async)
          || 15 }}% =
          {{ (taxRushReturns$ | async) || 0 }} ‚Ä¢ Enter either returns or percentage</div>
      </div>
    </div>
    <div class="row compact">
      <label>TaxRush Avg Net Fee</label>
      <div class="field">
        <div class="currency">
          <span class="prefix">$</span>
          <input type="number" class="input" appCurrencyInput [ngModel]="taxRushAvgNetFee$ | async"
            (ngModelChange)="updateTaxRushAvgNetFee($event)" placeholder="50" />
        </div>
      </div>
    </div>
    <div class="row compact">
      <label>TaxRush Gross Fees</label>
      <div class="field">
        <div class="currency">
          <span class="prefix">$</span>
          <input type="number" class="input" appCurrencyInput [ngModel]="taxRushGrossFees$ | async"
            placeholder="Auto-calculated" readonly />
        </div>
      </div>
      <div class="note">Auto: Returns √ó Avg Net Fee (override allowed)</div>
    </div>
  </div>
  }

  <!-- Discounts -->
  <div class="row">
    <label>Customer Discounts</label>
    <div class="field">
      <div class="dual">
        <div class="currency">
          <span class="prefix">$</span>
          <input type="number" class="input small" appCurrencyInput [ngModel]="discountsAmt$ | async"
            (ngModelChange)="updateDiscountsAmt($event)" placeholder="0" />
        </div>
        <span class="eq">=</span>
        <div class="percent">
          <label for="discounts-percentage" class="sr-only">Discounts Percentage</label>
          <input id="discounts-percentage" type="number" class="input small" appPercentageInput [maxPercent]="20"
            [ngModel]="discountsPctFormatted$ | async" (ngModelChange)="updateDiscountsPct($event)"
            [placeholder]="(regionalDiscountDefault$ | async) + '%'" title="Enter discount percentage (0% to 20%)" />
          <span class="suffix">%</span>
        </div>
      </div>
      <div class="delta-chip" *ngIf="(discountsDelta$ | async) as discountsDelta">
        Œî
        <span
          [ngClass]="{ 'delta-positive': discountsDelta > 0, 'delta-negative': discountsDelta < 0, 'delta-neutral': discountsDelta === 0 }">
          {{ discountsDelta | currency:'USD':'symbol':'1.0-0' }}
        </span>
      </div>
      <div class="note italic">Default: {{ (regionalDiscountDefault$ | async) }}% ‚Ä¢ Enter either dollar amount or
        percentage ‚Äî the other will auto-calc</div>
    </div>
    <div class="note">Dollar amount or % of gross fees given as discounts. Enter either field; the other
      auto-calculates.</div>
  </div>

  <!-- Total Tax Prep Income (projected) -->
  <div class="row">
    <label>Total Tax Prep Income</label>
    <div class="field">
      <div class="currency">
        <span class="prefix">$</span>
        <input type="number" class="input readonly" appCurrencyInput [ngModel]="taxPrepIncome$ | async"
          (ngModelChange)="overrideTaxPrepIncome($event)" placeholder="Auto-calculated" />
      </div>
      <div class="delta-chip" *ngIf="(taxPrepIncomeDelta$ | async) as incomeDelta">
        Œî
        <span
          [ngClass]="{ 'delta-positive': incomeDelta > 0, 'delta-negative': incomeDelta < 0, 'delta-neutral': incomeDelta === 0 }">
          {{ incomeDelta | currency:'USD':'symbol':'1.0-0' }}
        </span>
      </div>
    </div>
    <div class="note">Gross ‚àí Discounts (clear to re-auto)</div>
  </div>

  <!-- Other Income (projected) -->
  @if (showOtherIncome$ | async) {
  <div class="row">
    <label>Other Income</label>
    <div class="field">
      <div class="currency">
        <span class="prefix">$</span>
        <label for="other-income" class="sr-only">Other Income Amount</label>
        <input id="other-income" type="number" class="input" appCurrencyInput [ngModel]="otherIncome$ | async"
          (ngModelChange)="updateOtherIncome($event)" title="Enter other income amount" />
      </div>
    </div>
    <div class="note">Additional income not from tax prep</div>
  </div>
  }

  <!-- Total Expenses (projected) - Hidden like in Target/PY components -->
  <!-- <div class="grid-row">
    <label>Total Expenses</label>
    <div class="grid-field">
      <div class="inline">
        <span class="prefix">$</span>
        <input type="number" class="input sm readonly" 
               appCurrencyInput
               [ngModel]="totalExpenses$ | async" 
               placeholder="Auto-calculated" />
      </div>
    </div>
    <div class="small note">Auto: (Tax Prep Income + Other Income) √ó 76%</div>
  </div> -->

  <!-- Summary banner -->
  <div class="net-banner green">
    Projected Gross Net Income: {{ grossNetIncome$ | async | currency }}
    <span class="muted"> ‚Ä¢ Projected Gross Net per Return: {{ grossNetPerReturn$ | async | currency }}</span>
  </div>
</div>

<!-- Analysis Block (dev-visible; feature gated) -->
<section class="card" *ngIf="showAnalysis">
  <div class="card-title">Analysis</div>
  <lt-analysis-block [data]="analysisData" size="medium"></lt-analysis-block>
  <div class="small analysis-note">Dev-only: compares Custom vs selected preset</div>
</section>